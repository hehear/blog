const express = require('express');
const logger = require('../../common/log4js');
const router = express.Router();
const targetService=require('../service/targetService');
const resMsg = require('../model/resMsg');


router.post('/query', function (req, res) {
    logger.info('分页查询所有任务');

    var pageIndex=req.body.pageIndex;
    var page={
        pgsize:10,
        pgindex:pageIndex||1
    }
    var filter=req.body;
    filter.uid=req.cookies.uid;

    targetService.query4Page(filter,page,function(rows,page){

        if(rows==='error'){
            res.json(resMsg.getError('加载target出错啦'));
        }else{
            res.json(resMsg.getSuccess(rows,page));
        }
    })

});

router.get('/queryTargets', function (req, res) {

    logger.info('查询当前时间所有有效的任务类型，以及完成任务类型任务的个数');

    var filter={
        uid:req.cookies.uid
    }

    targetService.queryTargets(filter,function(rows){

        if(rows==='error'){
            res.json(resMsg.getError('加载target出错啦'));
        }else{
            res.json(resMsg.getSuccess(rows));
        }
    })

});
router.post('/queryTargetsByTp', function (req, res) {

    logger.info('按类型查询');

    var filter=req.body;

    filter.uid=req.cookies.uid;

    targetService.queryTargetsByTp(filter,function(rows){

        if(rows==='error'){
            res.json(resMsg.getError('加载target出错啦'));
        }else{
            res.json(resMsg.getSuccess(rows));
        }
    })

});
router.post('/updtCompleteSt', function (req, res) {

    logger.info('更改任务状态');

    var filter=req.body;

    targetService.updtCompleteSt(filter,function(rows){

        if(rows==='error'){
            res.json(resMsg.getError('加载target出错啦'));
        }else{
            res.json(resMsg.getSuccess(rows));
        }
    })

});

router.post('/updtCompleteContent', function (req, res) {

    logger.info('更改任务完成情况说明');

    var filter=req.body;

    targetService.updtCompleteContent(filter,function(rows){

        if(rows==='error'){
            res.json(resMsg.getError('加载target出错啦'));
        }else{
            res.json(resMsg.getSuccess(rows));
        }
    })

});

router.post('/save', function (req, res) {

    var filter=req.body;

    filter.uid=req.cookies.uid;

    if(filter.id){

        logger.info('修改任务');
        targetService.upt(filter,function(err){

            res.json(resMsg.getMessage(err));
        })

    }else{

        logger.info('新增任务');

        targetService.add(filter,function(err){

            res.json(resMsg.getMessage(err));
        })
    }

});

router.get('/delete', function (req, res) {

    var id=req.query.id;

    logger.info('删除任务，id：'+id);
    targetService.delete(id,function(err){

        res.json(resMsg.getMessage(err));
    })



});


//必须
module.exports = router;